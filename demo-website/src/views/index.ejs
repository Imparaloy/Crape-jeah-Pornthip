<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>J' Pornthip - Home</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
  // หากมี token ใน localStorage ให้เช็กสิทธิ์ แล้วพาไปหลังร้านอัตโนมัติ
  (async () => {
    const token = localStorage.getItem('token');
    if (!token) return; // ยังไม่ล็อกอิน => อยู่หน้า user ต่อ

    try {
      const res = await fetch('/api/me', {
        headers: { 'Authorization': 'Bearer ' + token }
      });
      if (!res.ok) return; // token ไม่ถูก/หมดอายุ => ไม่เด้ง

      const data = await res.json();
      const role = data?.user?.role;

      if (role === 'seller' || role === 'admin') {
        // ป้องกันวนลูป: ถ้าอยู่ที่ /orders แล้ว หรือเพิ่ง redirect ไปแล้วใน session นี้ ให้หยุด
        if (location.pathname === '/orders' || sessionStorage.getItem('redirectedToOrders') === '1') return;
        sessionStorage.setItem('redirectedToOrders', '1');
        // เปลี่ยนหน้าโดยไม่ยัดประวัติ (กด back จะไม่วน)
        location.replace('/orders');
      }
    } catch (e) {
      // เงียบไว้เพื่อไม่รบกวน UX หน้าแรก
      console.debug('role check skipped:', e);
    }
  })();
</script>

</head>
<body class="bg-[#fdf4ee]">
  <%- include('components/navbar') %>

  <main class="container mx-auto px-4 py-8">
    <!-- Recommended Menu Section -->
    <section class="mb-12">
      <h2 class="text-2xl font-bold mb-6">Recommended menu</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
        <% if (recommendedMenus && recommendedMenus.length > 0) { %>
          <% recommendedMenus.forEach(menu => { %>
            <div class="flex justify-center">
              <%- include('components/menu-card', { menu }) %>
            </div>
          <% }) %>
        <% } else { %>
          <p class="text-gray-500">ไม่มีเมนูแนะนำในขณะนี้</p>
        <% } %>
      </div>
    </section>

    <!-- All Menu Section -->
    <section class="mb-12">
      <h2 class="text-2xl font-bold mb-6">Menu</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
        <% if (menus && menus.length > 0) { %>
          <% menus.forEach(menu => { %>
            <div class="flex justify-center">
              <%- include('components/menu-card', { menu }) %>
            </div>
          <% }) %>
        <% } else { %>
          <p class="text-gray-500">ไม่มีเมนูในขณะนี้</p>
        <% } %>
      </div>
    </section>

    <!-- Customize Section -->
    <section class="mb-12">
      <h2 class="text-2xl font-bold mb-6">Customize crepe</h2>
      <div class="bg-white rounded-2xl shadow-lg p-8 text-center hover:shadow-xl transition-shadow">
        <div class="w-32 h-32 mx-auto mb-4 rounded-full bg-gray-100 flex items-center justify-center">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 text-red-700" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
          </svg>
        </div>
        <p class="text-gray-600 mb-6">สร้างเครปสไตล์คุณเอง</p>
        <a href="/customize" class="bg-red-700 text-white px-8 py-3 rounded-lg hover:bg-red-800 transition-colors inline-block">
          Start Customizing
        </a>
      </div>
    </section>
  </main>
  <footer class="bg-[#C24025] text-[#FDECC8] py-6 mt-12">
    <div class="container mx-auto px-4 text-center">
      &copy; 2024 J' Pornthip. All rights reserved.
    </div>
  </footer>
  <script>
    async function addToCart(menuId) {
      try {
        const token = window.localStorage.getItem('token');
        if (!token) {
          // ต้องเข้าสู่ระบบก่อนจึงจะเพิ่มลงตะกร้าได้
          window.location.href = '/login';
          return;
        }
        const res = await fetch('/api/cart/items', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            Authorization: `Bearer ${token}`,
          },
          body: JSON.stringify({ menuId, qty: 1 }),
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.message || 'เพิ่มลงตะกร้าไม่สำเร็จ');
        showToast('เพิ่มลงตะกร้าแล้ว');
      } catch (err) {
        showToast(err.message || 'เกิดข้อผิดพลาด', true);
      }
    }

    function showToast(message, isError = false) {
      let toast = document.getElementById('global-toast');
      if (!toast) {
        toast = document.createElement('div');
        toast.id = 'global-toast';
        toast.className = 'fixed bottom-6 left-1/2 -translate-x-1/2 z-50 rounded-full px-5 py-3 shadow-lg text-sm';
        document.body.appendChild(toast);
      }
      toast.textContent = message;
      toast.classList.remove('bg-red-600','text-white','bg-green-600');
      toast.classList.add(isError ? 'bg-red-600' : 'bg-green-600', 'text-white');
      toast.style.opacity = '1';
      setTimeout(() => { toast.style.transition = 'opacity .4s'; toast.style.opacity = '0'; }, 1400);
    }
  </script>
</body>
</html>
