<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Orders | Admin</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-[#FFF8F0] min-h-screen">

<%- include('components/navbar-admin', {
  activePath: (typeof activePath !== 'undefined' && activePath) ? activePath : '/orders',
  me: (typeof me !== 'undefined') ? me : null
}) %>

  <main class="max-w-6xl mx-auto py-6 px-4">
    <h1 class="text-3xl font-bold mb-2">Orders</h1>
    <div class="text-sm text-stone-700 mb-6 space-x-6">
      <span>Total : <%= counters?.total ?? 0 %></span>
      <span>In Process : <%= counters?.inProcess ?? 0 %></span>
      <span>Served : <%= counters?.served ?? 0 %></span>
    </div>

  <div class="flex items-center gap-3 mb-6">
    <a href="/orders?status=all"
       class="inline-flex items-center gap-2 px-4 py-2 rounded-lg border
              <%= activeTab==='all' ? 'bg-amber-200 border-amber-300' : 'bg-white border-stone-200' %>">
      <span class="text-sm font-semibold "><%= counters?.total ?? 0 %></span> All
    </a>
    <a href="/orders?status=in"
       class="inline-flex items-center gap-2 px-4 py-2 rounded-lg border
              <%= activeTab==='in' ? 'bg-amber-200 border-amber-300' : 'bg-white border-stone-200' %>">
      <span class="text-sm font-semibold"><%= counters?.inProcess ?? 0 %></span> In Process
    </a>
    <a href="/orders?status=served"
       class="inline-flex items-center gap-2 px-4 py-2 rounded-lg border
              <%= activeTab==='served' ? 'bg-amber-200 border-amber-300' : 'bg-white border-stone-200' %>">
      <span class="text-sm font-semibold"><%= counters?.served ?? 0 %></span> Served
    </a>
  </div>

    <div class="grid md:grid-cols-2 gap-6">
      <% if (orders && orders.length > 0) { %>
        <% orders.forEach((o) => { %>
        <div class="bg-[#FFFBF5] rounded-2xl border border-stone-200 p-6" data-order-card>
            <div class="flex items-start justify-between mb-4">
              <div>
                <h2 class="text-xl font-semibold">Order #<%= o.orderNumber ?? o.idShort %></h2>
                <% if ((o.time ?? '-') !== '-') { %>
                  <div class="text-sm text-stone-500">เวลา <%= o.time %></div>
                <% } %>
              </div>
              <% const isServed = (o.status ?? '') === 'Served'; %>
              <% const isInProcess = (o.status ?? '') === 'In Process'; %>
              <span data-status-badge
                    class="inline-flex items-center gap-2 px-3 py-1 rounded-full text-sm text-white <%= isServed ? 'bg-green-600' : 'bg-amber-500' %>">
                <%= isServed ? 'Served' : 'In Process' %>
              </span>
            </div>

            <div class="space-y-4 text-stone-800">
              <% if (Array.isArray(o.items) && o.items.length) { %>
                <% o.items.forEach(function(item){ %>
                  <div class="rounded-xl border border-stone-200 bg-white px-4 py-3">
                    <div class="flex items-start justify-between gap-4">
                      <div class="space-y-2">
                        <div class="text-base font-semibold">
                          <%= item.name %>
                          <span class="ml-2 text-sm font-normal text-stone-600">×<%= item.quantity %></span>
                        </div>
                        <% if (item.details && item.details !== '-') { %>
                          <div class="text-sm text-stone-600">รายละเอียด: <%= item.details %></div>
                        <% } %>
                        <% if (Array.isArray(item.toppings) && item.toppings.length) { %>
                          <div class="flex flex-wrap gap-2">
                            <% item.toppings.forEach(function(top){ %>
                              <span class="inline-flex items-center rounded-full bg-amber-50 border border-amber-200 px-3 py-1 text-xs text-amber-900">
                                <%= top %>
                              </span>
                            <% }) %>
                          </div>
                        <% } %>
                      </div>
                      <div class="text-right text-stone-700">
                        <div class="text-sm text-stone-500">@ ฿<%= Number(item.unitPrice ?? 0).toFixed(2) %></div>
                        <div class="text-lg font-semibold text-stone-800">฿<%= Number(item.linePrice ?? 0).toFixed(2) %></div>
                      </div>
                    </div>
                  </div>
                <% }) %>
              <% } else { %>
                <div class="text-sm text-stone-500">ไม่มีรายการอาหาร</div>
              <% } %>
            </div>

            <% if (o.note && o.note.trim() !== '') { %>
              <div class="mt-4 rounded-xl border border-amber-200 bg-amber-50 px-4 py-3 text-sm text-amber-900">
                หมายเหตุ: <%= o.note %>
              </div>
            <% } %>

            <div class="mt-4 flex items-center justify-between text-stone-800">
              <span class="text-sm text-stone-600">ยอดรวม</span>
              <span class="text-xl font-semibold">฿<%= Number(o.price ?? 0).toFixed(2) %></span>
            </div>

            <div class="mt-5">
              <% if (isInProcess) { %>
                <button class="w-full rounded-xl border px-4 py-3 bg-green-100 hover:bg-green-200 js-update-status"
                        data-order-id="<%= o.id %>" data-current-ui="In Process">
                  Mark as Served
                </button>
              <% } else if (isServed) { %>
                <div class="w-full rounded-xl border border-green-200 bg-green-50 px-4 py-3 text-center font-semibold text-green-700">
                  Served
                </div>
              <% } else { %>
                <div class="w-full rounded-xl border border-stone-200 bg-stone-50 px-4 py-3 text-center text-stone-600">
                  สถานะ: <%= o.status %>
                </div>
              <% } %>
            </div>
          </div>
        <% }) %>
      <% } else { %>
        <p class="text-stone-500">No orders available.</p>
      <% } %>
    </div>
  </main>

  <script src="/js/orders-admin.js"></script>
</body>
</html>
